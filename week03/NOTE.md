## 解析HTML，构建DOM树

第一步

- 为了方便文件管理，我们把parser单独拆到文件中
- parser接收HTML文本作为参数，返回一颗DOM树

HTML语法可参考[HTML标准](html.spec.whatwg.org/multipage/)，共80个词法状态

第二步

* 我们用FSM来实现HTML的分析
* 在HTML标准中，已经规定了HTML的状态
* Toy-Browser只挑选其他一部分状态，完成一个最简版本

使用状态机区分三种tag。

状态机最大的作用是，在每一个状态可以去做一些计算。

第三步

如何通过状态机的每个状态，在里面适当的位置插入我们的计算逻辑？

- 主要的标签：开始标签，结束标签和自封闭标签
- 暂时忽略属性

第四步

- 在状态机中，除了状态迁移，我们还会要加入业务逻辑
- 我们在标签结束状态提交标签token

第五步

- 属性值分为单引号、双引号、无引号三种写法，因此需要较多状态处理
- 处理属性的方式跟标签类型
- 属性结束时，把属性加到标签Token上 

用栈构建DOM的原理

`emit(token)`会接收到从状态机里产出的所有的token，例如开始标签、结束标签、自封闭标签。

个人见解：emit操作概括来说，就是在词法分析过程中通过辅助栈做标签的配对，来构建DOM树。

词法分析得到的栈，往里面push一个document节点。因为配对良好的HTML片段，它最后整个栈应该是空的，不方便把这棵树拿出来。所以给栈一个初始的根结点。 

区分tag和element：写在HTML的tag背后就是node或者element。

第六步

- 从标签构建DOM树的基本技巧是使用栈
- 遇到开始标签时创建元素并入栈，遇到结束标签时出栈
- 自封闭结点可视为入栈后立刻出栈
- 任何元素的父元素是它入栈前的栈顶

遇到字符型的token，就追加到当前文本结点里的content。相邻的文本结点会被合并。

第七步

- 文本结点与自封闭标签处理类似
- 多个文本结点需要合并

总结：应用状态机来解析字符串，做词法分析。在各个状态里编写业务逻辑，指的是`emit(token)`来构建DOM树）。在`emit(token)`里将三种闭合标签，文本标签构建成DOM树。

## CSS Computing

第一步

收集CSS规则

- 遇到style标签时，我们把css规则保存起来
- 调用CSS Parser来分析CSS规则
- 要仔细研究此库分析CSS规则的格式



第二步 

找合适的时机，应用上CSS规则。

CSS里的一个设计原则时，保证所有的选择器在匹配到元素startTag时就能应用上规则。

- 当创建一个元素后，立即计算CSS
- 理论上，分析一个元素时，所有CSS规则已经收集完毕
- 在真实浏览器中，可能遇到写在body的style标签，需要重新CSS计算的情况，忽略此情况



第三步

获取父元素序列

- 在computeCSS函数，必须知道元素的所有父元素才能判断元素与规则是否匹配
- 从上一个步骤的stack，可以获取本元素所有的父元素
- 首先获取的是当前元素，所以获得和计算父元素匹配的顺序是从内向外



第四步

处理选择器跟元素的匹配。

CSS选择器结构：最外层是`选择器列表`。

列表里是`复杂选择器`，以空格分隔的一系列`复合选择器`。

* 选择器也要从当前元素向外排列
* 复杂选择器拆成针对单个元素的选择，用循环匹配父元素队列



第五步

计算选择与元素匹配

- 根据选择器的类型和元素，计算是否与当前元素匹配
- 案例仅实现了三种基本选择器，实际浏览器中要处理复合选择器



第六步

生成computed属性，将声明的属性逐条作用到元素中

- 一旦选择匹配，就应用选择器的元素上，形成computedStyle



第七步

specificity的计算逻辑

``` js
div div #id
[0, 1, 0, 2]
inline id class tag

比较四元组，得到两条规则的优先级高低
```

- CSS规则根据specificity和后来优先规则覆盖 
- specificity诗歌四元组，越左边权重越高
- 一个CSS规则的specificity根据包含的简单选择器相加而成

总结：从代码实现的维度，认识了在DOM构建过程中是如何做应用上CSS规则的；选择器是如何与DOM元素匹配的; 生成specificity来比较规则的优先级，应用规则。

---

## 本周总结

使用状态机做字符串解析，太棒了！我还想知道字符串解析技术、或者状态机可以怎样应用到工程项目上。

这周学习，让我对HTML解析、CSS计算不再停留感性认识上。通过案例编码，我更加深入理解其中奥妙之处。